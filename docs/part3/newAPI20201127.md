## 新增API需求（11/28/2020）

### ***1、获取Viewer中当前用户的状态(黄月瑶)

|  方法名  |                       getUserStateByID                       |
| :------: | :----------------------------------------------------------: |
| 传入参数 | Viewer当前用户的 userID 和 roleID 和 当前case的StudyInstanceUID |
|  返回值  | 用户的状态<br>对于roleID为3的用户来说，用户的状态 根据user_case 表中的 annotated 判定，annotated为1则userState为0，否则userState为1；<br>对于roleID为2的用户来说， 用户的状态根据 case_info 表中的provedStatus判定，provedStatus为1则userState为0，否则userState为1； <br>对于roleID为1或0的用户来说，用户的状态根据hospital_user_case表的状态确定，如果有该userID和caseID的记录，则userState为1 |
|   备注   | user_case表中的annotated由原来的boolean改为int，-1为未标注，0为标注中，1为已标注 |

```javascript
POST /getUserStatebyID
[{
    userID: 
    roleID:
    StudyInstanceUID:
}]

[{
    userState: 0,// userState为0代表该用户是只读状态，为1代表该用户是可编辑状态
}]
```
### ***2、处理Viewer提交任务的请求(黄月瑶)

|  方法名  |                     annotationTaskCommit                     |
| :------: | :----------------------------------------------------------: |
| 传入参数 | Viewer当前用户的userID和roleID、当前case的StudyInstanceUID和所提交的标注 |
|  返回值  | 调用/measurements/insertOrReplace，将提交的标注保存，根据roleID修改相应的状态，返回成功或者失败的状态码 |
|   备注   | roleID为3时，修改user_case表中的annotated，改为1（标注完成）；<br>roleID为2时修改case_info表中的provedStatus，改为1（审核完成）; <br>roleID为1或0时，查看hospital_user_case表中有没有该userID和caseID的记录，没有就插入该条记录 |

```javascript
POST /annotationTaskCommit
[{
    userID: 
    roleID:
    caseID: 
    measurementsData:[{}]
}]

调用/measurements/insertOrReplace，将提交的标注保存，根据roleID修改相应的状态，返回成功或者失败的状态码
```

### ***3、处理Viewer的retrieveMeasurements的请求(王璟玲)

|  方法名  |                      getMeasurementById                      |
| :------: | :----------------------------------------------------------: |
| 传入参数 | Viewer当前用户的userID和**roleID**、当前case的StudyInstanceUID |
|  返回值  |               根据roleID判断返回相应的标注信息               |
|   备注   | roleID为3时，返回measurements表中相应的数据；<br>roleID为2时，返回reviewer_measurements表中相应的数据;<br> roleID为1或0时，根据hospital_user_case的记录判断，hospital_user_case表中 存在 该用户和该case的记录，代表使用者对模型数据进行了修改，则返回measurements表中相应的数据；<br>hospital_user_case表中 不存在 该用户和该case的记录，代表使用者没有对模型数据进行修改，则返回ai_measurements表中模型的数据（如果有多个模型版本的数据，选择一个作为默认选择） |

source ai_measurements measurements reviewer_measurements

```javascript
POST /measurements/getMeasurementById
[{
    StudyInstanceUID:
    userID: 
    roleID:
}]

[{
    
}]
```

### ***4、处理Viewer的storeMeasurements的请求(王璟玲)

|  方法名  |                    insertIntoMeasurements                    |
| :------: | :----------------------------------------------------------: |
| 传入参数 | Viewer当前用户的userID和**roleID**、当前case的StudyInstanceUID和所提交的标注 |
|  返回值  |                   返回是否保存成功的状态码                   |
|   备注   | roleID为3时，修改user_case表中相应的标注状态annotated，annotated改为0（标注中），标注信息保存到measuremens表中；<br>roleID为2时修改case_info中的provedStatus，provedStatus改为0（审核中），标注信息保存到reviewer_measuremens表中; <br>roleID为1或0时，查看hospital_user_case表中有没有该userID和caseID的记录，没有就插入该条记录，标注信息保存到measuremens表中 |

```javascript
POST /node_search/measurements/insertOrReplace
[{
    userID: ,
    roleID: ,
    PatientID: ,
    StudyInstanceUID: ,
    SeriesInstanceUID: ,
    caseID: ,
    measurementsData: [{}]
}]

修改相应状态，返回保存成功或者失败的状态码
```
### **5、返回每条病例已有的所有标注来源(王璟玲)

|  方法名  |      getCasesAllMeasurementsSource       |
| :------: | :--------------------------------------: |
| 传入参数 | 所要查询标注结果的case的StudyInstanceUID |
|  返回值  |   所要查询标注结果的case的所有标注来源   |

```
POST /getCasesAllMeasurementsSource
[{
  caseList:[],
  
}]

[{
  measurementsSource:[]
}]
```

### **6、DeepIS为标注者分配病例界面根据分配者选择的标注结果为标注者copy参考数据(王璟玲)

|  方法名  |             copySelectedMeasurementsForAnnotator             |
| :------: | :----------------------------------------------------------: |
| 传入参数 | 被分配任务的标注者的userID、被分配的case的StudyInstanceUID、所选的需要copy的标注来源 |
|  返回值  |                       是否成功的状态码                       |

```javascript
POST /copySelectedMeasurementsForAnnotator
[{
    userID:
    StudyInstanceUID:
    measurementsSource:
}]

状态码
```
### **7、NMS合并操作生成reviewer_measurements(黄月瑶)

|  方法名  |                combineAnnotatorsMeasurements                 |
| :------: | :----------------------------------------------------------: |
| 传入参数 | Viewer当前用户的userID（前端选择只有roleID为3的会做此请求）、当前case的StudyInstanceUID |
|  返回值  |                   修改相应状态，返回状态码                   |
|   备注   | 判断该case是否是多人负责标注的，如果该例case只有一人负责标注，直接将该人对该例case的标注按格式copy到reviewer_measurements表中，并修改相应状态即可；<br>如果该例case由多人负责标注，需要判断是否每个人都已提交标注，如果所有负责标注该例case的标注者都已提交，则进行nms操作后，将合并结果写入copy到reviewer_measurements表中；<br>否则，返回xxx尚未提交标注 |

```javascript
POST /combineAnnotatorsMeasurements 
[{
    userID:
    StudyInstanceUID:
}]


```
### **8、根据measurement的唯一标识返回单条measurement的信息

|  方法名  |      |
| :------: | :--: |
| 传入参数 |      |
|  返回值  |      |

```

```



### *9、处理Viewer的retrieveSelectedMeasurements的请求(黄月瑶)

|  方法名  |                   getSelectedMeasurements                    |
| :------: | :----------------------------------------------------------: |
| 传入参数 | Viewer当前用户的userID和roleID、当前case的StudyInstanceUID、所选的标注来源 |
|  返回值  |              用户所选择的标注信息 或者 失败信息              |

```javascript
POST /getSelectedMeasurements
[{
    userID:
    roleID:
    StudyInstanceUID:
    measurementsSource:
}]

[{
    
}]
```
